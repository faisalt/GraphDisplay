<html>
	<head>
	
		<title>Graph Display - Navigation Study</title>
		
		<!-- Styles --> 
		<link rel="stylesheet" type="text/css" href="common.css">
		<style type="text/css">
			
			#datainfo { display: none; }
			
			.scroll 				{ position:fixed;  border: 2px solid white; }
			.scroll .nub			{ position: absolute; display: block; border-radius: 5px; background-color: orange; }
			.scroll .ghost			{ position: absolute; display: block; border-radius: 5px; border: 1px solid gray; background-color: rgba(255, 255, 255, 0.6); }
			
			#hscroll.scroll 		{ bottom: 3%; left: 25%; width: 50%; height: 6%; background-color: blue; }
			#hscroll.scroll .nub	{ width: 10%; height: 100%; }
			#hscroll.scroll .ghost	{ width: 10%; height: 100%; }
			
			#vscroll.scroll 		{ top: 25%; left: 3%; height: 50%; width: 6%; background-color: red;  display: none; }
			#vscroll.scroll .nub	{ width: 100%; height: 8%; }
			#vscroll.scroll .ghost	{ width: 100%; height: 8%; }
			
			.axislabel div.text { color: white; font-size: 12px; line-height: 12px; }
			
			.page { position:fixed; bottom: 10%; width: 10%; height: 50px; background-color: green; line-height: 50px; color: white; font-size: 48px; text-align: center; }
			#pageleft { left: 5%; }
			#pageright { right: 5%; }
			
		</style>
		
		<script type="text/javascript" src="js/jquery-1.8.2.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.9.1.custom.min.js"></script>
		<script type="text/javascript" src="js/jquery.nearest.min.js"></script>
		<script type="text/javascript" src="js/reconnecting-websocket.js"></script>
		<script type="text/javascript" src="js/ubidisplays-multitouch-0.8.js"></script>
		<script type="text/javascript" src="graph.js" type="text/javascript"></script>
		<script type="text/javascript" src="datasets.js"></script>
		
		<script type="text/javascript">
			// UK Rainfall (mm)
			// Areal series, starting from 1910
			// Allowances have been made for topographic, coastal and urban effects where relationships are found to exist.
			// Seasons: Winter=Dec-Feb, Spring=Mar-May, Summer=June-Aug, Autumn=Sept-Nov. (Winter: Year refers to Jan/Feb).
			// Values are ranked and displayed to 1 dp. Where values are equal, rankings are based in order of year descending.
			// From here: http://www.metoffice.gov.uk/climate/uk/datasets/#
			var dDataSet = {
				columns : [1910,1911,1912,1913,1914,1915,1916,1917,1918,1919,1920,1921,1922,1923,1924,1925,1926,1927,1928,1929,1930,1931,1932,1933,1934,1935,1936,1937,1938,1939,1940,1941,1942,1943,1944,1945,1946,1947,1948,1949,1950,1951,1952,1953,1954,1955,1956,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012],
				rows	: ["UK", "England", "Wales", "NorthWest", "NorthernIreland", "NorthEast", "Midlands", "London", "SouthEngland", "NorthEngland", "AngliaEast"],
				block : [
					[1148.9,1022.4,1242,1027.4,1118.6,1075.6,1202.6,1042.4,1136.9,1034.5,1139.8,905.4,1050.8,1220,1177.7,1062.2,1094.5,1217.2,1258.5,1063.7,1180.4,1114.9,1105.1,835.4,1056.1,1143.3,1063.4,1014.7,1183.9,1097.7,1047.5,944.8,1026.9,1071.9,1084.5,1008.1,1152.2,988.5,1207.9,1053.1,1202.4,1198.3,1009.6,952.9,1309.1,899.8,1047.7,1101.3,1135.9,993.2,1198.8,1054.3,1004.6,975.6,895.5,1111.5,1159.8,1174.5,1045.6,980,1095,912.9,961.2,905.2,1153.1,899.4,951.5,1079,1039.7,1144.8,1129,1156.4,1170.3,1061.8,1066,1074.3,1185,1036.3,1133,1020.7,1175,999.7,1188.8,1122.5,1186.6,1025.2,918,1025.6,1267.1,1239.1,1337.3,1052.8,1283.7,904.2,1213.6,1086.2,1179.2,1200.3,1295,1213.3,950.5,1172.5,1334.8],
					[917.8,772.7,1017.7,785.4,885.6,907.7,942,801.5,871.8,847.7,854.5,567,852.2,907.7,965.1,859.1,821.2,989.9,920.7,806.1,947.2,893.1,830.7,657.5,763.6,909.3,874.8,882.6,808.5,918.8,816.6,776.6,756.8,755.7,822.5,750.2,962.9,736.2,861.7,716.6,915.7,993.8,802.7,684.9,992.3,702.8,791,814.9,947.6,740.6,1070.9,792,719.4,779.9,645.3,906.7,936.1,896.6,891.7,811.6,822.4,721.8,768.8,657.8,907.1,679.3,721.4,835.7,806.9,893.1,873.3,899.2,866.1,789.4,823.3,797.2,891.8,834.5,828.8,726,743.6,707.3,859.9,889.7,901.3,741.7,670.3,773.3,954.3,922.9,1093.3,862.8,1006.6,675.8,891.5,747,846.7,934.5,982.1,875,727.2,713.1,1126.1],
					[1568.5,1331.3,1581.3,1439.5,1447.1,1376.9,1410.8,1274.8,1531.2,1298.6,1647.7,1096.7,1328.7,1590.6,1597.6,1393.3,1324,1596.7,1680.4,1462.4,1594.5,1461.3,1397.8,1015,1302.3,1441.2,1419.2,1219.2,1436,1473.1,1320,1130.7,1272.1,1380.6,1338.4,1290,1572.2,1267.4,1561.4,1242.1,1589.8,1571.9,1311.1,1204.2,1768.2,1172.7,1202.6,1491.8,1536.4,1338.5,1699.4,1324.6,1219.3,1194.3,1084.7,1447.3,1452.4,1538.9,1315.2,1228,1428.1,1156.4,1362.6,1108.5,1561.7,1088.4,1088.7,1415.6,1232.3,1443.5,1412.7,1490.2,1498,1360.9,1290.9,1360.2,1520.6,1323.5,1430.7,1306.8,1347.6,1258,1432.2,1387,1578.8,1204.9,1161,1268.5,1654.3,1584.3,1828.6,1349.2,1626.6,1139.5,1487.3,1305,1467.6,1484.3,1663.9,1495.7,1127.5,1287.1,1703.3],
					[1323.1,1191.3,1370.2,1184.8,1271.6,1184.8,1307.3,1201.9,1445.6,1173.2,1428.4,1107.9,1230.1,1544.2,1382.1,1259.5,1274.2,1456.3,1602,1292.4,1443.5,1403.7,1294.7,905.5,1206.1,1315.3,1282.4,1053.2,1405.6,1278.9,1187.2,991.5,1171.8,1312.1,1313.9,1124.2,1403.4,1145.4,1377.9,1195.7,1428.6,1441.3,1149.2,1122.4,1689.3,1002.5,1195.1,1351.1,1352.8,1136.5,1434.9,1246.5,1167.9,1114.9,1058.5,1307.8,1326.7,1430.4,1231.9,1119.7,1275,998.6,1167.8,1058,1348.1,1038.9,1049.7,1265.4,1187,1294.9,1372.4,1382.2,1326.6,1258.7,1160,1212,1349.8,1264.5,1324.4,1136.6,1280.8,1117.4,1291.5,1207.4,1387.1,1048.5,999.2,1126.3,1454.5,1406.4,1650.7,1175.3,1465,1073.3,1402.3,1206.9,1396,1357.9,1549.3,1357.7,1027.1,1333.7,1625.2],
					[1114,953.9,1209.1,1056.6,1077.5,1034.3,1185.5,1162.3,1187,1053.1,1228,998.9,1052.3,1303.3,1232.7,1062.4,1067.6,1060.2,1362.5,1113.5,1160.2,1176.6,1037.8,784.6,1111.9,1054.8,1138.1,1035.5,1196.8,1032.4,1151,973.9,1190.7,1124.4,1147.3,1037.3,1142.4,1099.3,1170.4,1048.6,1242.1,1075.4,942.5,843.4,1276.6,979,1050.6,1132.1,1218.3,964.7,1209,1105.6,1041.4,1100.3,1007.2,1165.8,1276.1,1203.4,1084,1000,1159.3,901.1,1037.2,964.1,1137,851.2,1057.3,1088,1131.9,1165.7,1181.7,1236.8,1174.8,976.1,1073.1,1134.8,1203.7,988.6,1254.3,1002,1270.3,1045.1,1184.5,1167.1,1171.2,1080.5,1096.2,1043.2,1259.1,1238.6,1223.4,899,1411,938.6,1093.4,1073.5,1155.4,1096.8,1270.7,1260.1,1047.1,1272.6,1186.5],
					[792.4,743.5,922.7,676.7,766.2,782.5,889.8,741.3,759.5,797.2,787.2,581.1,785.5,821,793.7,778.1,770,906,815,662.2,907.1,870.5,732.5,674.4,747.5,810.7,819.3,835.4,777.6,837.3,749.2,746.1,651.4,682.6,830.1,704.7,843.2,711.8,795.9,627.3,852.8,883.8,691.9,628.9,915.3,607.5,786.2,733.7,843.2,590.9,941.3,722.7,640.9,735.5,542.4,866.4,856.4,810.4,820.3,795.8,701.1,628.9,641.3,603.2,732.5,600.7,691.8,732.7,819.5,830.5,826.8,785.7,732.3,735.5,733.7,761.3,801.3,800.6,751.7,552.7,666.5,605.9,752.5,813.5,755.5,640.8,598.5,704.7,862.6,801.7,972.6,786.1,903,614.7,872.3,752.4,767.9,825,951.5,803.6,738.3,661.7,1043],
					[867.3,653,986.4,745.5,806,854.6,848,742.8,796.4,814.3,840.2,540.9,828.1,863.2,916,780.1,765.9,925.5,839.3,741,925,875,798.7,613.9,663.6,854,833.9,793.6,749.3,858.5,786.1,774.4,684.8,673,776.8,700,909.5,696,822.5,684,824.3,933.1,731.2,644.1,945.4,658.6,751.6,781,919.4,674.7,1032.9,722.1,660.6,690.8,582.2,869.3,898.1,828,860.1,785.3,778.4,708.6,741.4,644.5,803.1,589,668.7,816,745.4,840,840,848.2,798.2,759.2,765.4,745.5,840.9,764.5,771.3,718.4,676.4,653.3,854.4,822,832.3,665,611.1,724.1,887.8,893.9,1018.3,794.3,924.8,612.7,840.5,683.9,795.7,928.6,937.4,780.6,647,594,1085],
					[869.2,748.5,928.7,765.1,860.5,974.2,912.1,775.4,786,786.5,731.1,406.2,772.4,807.5,958.4,865.5,773.3,995.6,841.1,750,808.9,722.6,740.8,604.1,723,940.9,803.1,927.1,656.5,899.7,765,738.9,722.4,661,677.3,654.3,914.9,633,768.4,646.3,823.7,1043.3,777.4,616.5,852.6,684.9,703.1,728.3,898.9,723.2,1068.4,736.2,677.8,763.9,638,806.1,900.8,852.4,860.3,714.5,776.2,703.6,700.1,559.1,963,712.5,665.8,812.7,711.6,834.7,756.2,822.8,826.1,694.9,806,726.8,822.5,773.4,709.2,673.7,654,671.8,796.6,847.6,873.1,744.9,613.7,721,863.1,834.9,1104.3,860.8,1005.1,641.8,756.9,612,788.4,845.2,851.1,821.7,689.9,629.8,1004],
					[886.1,704.9,975.3,751.2,849.6,900.4,889,751.2,796.7,808.2,775.3,456.9,796,809.6,952.1,810.9,749.7,939.1,821.4,766.1,868.3,801.2,780.6,604.6,691.5,862.6,825.2,880.3,695.1,890.6,776.4,747.8,714.9,678.2,717.6,695.1,918,663.9,798.2,651.5,848.8,948.7,781.3,623.9,882.6,686.6,708.5,751.9,910.3,725.9,1050.6,726.8,661.6,729.4,597.7,846.3,880.1,819.5,842.4,756.9,782.5,704.3,730.6,603.5,889.4,645.7,666.5,791.3,733.8,834.6,784.2,833,827.4,712.5,784.9,737.8,829.1,768.1,754.3,708.7,664.9,662.6,822.3,860.3,859.5,726.7,631.1,732.2,893.8,879.6,1029.5,839.1,947.7,630.5,802.2,669.4,767.8,889,884.8,806.2,674,602.2,1046.5],
					[977.6,901,1098.1,849.9,953.7,921.4,1042.2,896.5,1014,922.4,1004.1,775.2,958.5,1093.2,989.8,950.4,956.4,1085.9,1108.4,881.7,1096.5,1066.7,925.4,757.5,899.9,997.5,968.7,887,1023.1,972.3,892.5,830.8,836,902.4,1020.7,854.3,1048,873.1,981.8,839.8,1042.2,1079.1,843.1,800.2,1199.8,733.4,946.9,934,1018.1,768.3,1109.4,915.5,828.8,875.6,735.4,1021.2,1042.2,1042.6,985.1,915.1,898.1,754.9,841.3,760.7,940.6,742.7,825.3,919.9,945.2,1004,1042,1024.4,939.4,934.9,895.9,909.5,1010.3,960,969.8,758.8,892.5,791.8,931,945.3,980.2,770.2,744.3,850.8,1068.9,1004.9,1214,907.6,1118.1,761.5,1060.2,893.6,996,1020.4,1166.1,1005.1,827.8,922.9,1276.8],
					[693.2,584.8,776.8,543.9,632.2,696,749.2,627.9,673.6,660.6,547.5,346.4,633.2,612.8,727.1,601.6,613.9,748.2,614.8,539,676.9,633.1,577.9,472.1,503.4,644.1,678.5,749,515.8,758.4,603.5,616,596,484.1,579.5,548.7,717.4,490.5,604.1,490.4,661.5,733.3,629.2,506.9,678.2,520.3,580.1,580.4,745.5,481.2,768.7,605.3,525.5,569.2,490.3,690.9,679.1,602.8,691.4,612.6,613.4,561.3,475.6,494.1,670.9,552.7,510.7,569.5,610.3,664.1,582.2,649.9,655,564.1,636.7,579.8,636.9,701.3,625.2,537,482.4,478.7,696.7,718.6,621.2,553.5,461.3,534.1,713.5,671.1,778.8,779.6,708.4,517.6,677.3,530.6,610,690.4,684.9,599.4,585.1,453.7,810],
				]
			};
			
			// Compute max and min for the data block.
			dDataSet.max = dDataSet.block.reduce(function(max, arr) { return Math.max(max, arr[0]); }, -Infinity);
			dDataSet.min = dDataSet.block.reduce(function(min, arr) { return Math.min(min, arr[0]); },  Infinity);
		</script>
		
	</head>
	<body>
		
		<!-- STUDY BUTTONS -->
		<div id="studyheader">
			<p>Navigation Study</p>
			<ul id="modes">
				<li mode="V1"><span>V1</span><span>Virtual Slider Only<span></li>
				<li mode="V2"><span>V2</span><span>Virtual Paging<span></li>
				<li mode="P1"><span>P1</span><span>Physical Paging +1<span></li>
				<li mode="P2"><span>P2</span><span>Physical Paging +10<span></li>
			</ul>
		</div>
		
		<!-- FUNCTION RENDER -->
		<div id="datainfo">
			<span class="title"></span>
			<br/>
			<br/>
			<span class="row"></span>
			<span class="col"></span>
			<br/>
			<span class="value"></span>
		</div>
		
		<div id="hscroll" class="scroll"><div class="nub"></div><div class="ghost"></div></div>
		<div id="vscroll" class="scroll"><div class="nub"></div><div class="ghost"></div></div>
		
		
		<div id="pageleft"  class="page" step="-1"> < </div>
		<div id="pageright" class="page" step=" 1"> > </div>
		
		<script>
			// Constants
			var STUDY = 8383;					// Port for connection to the study behaviour.
			var dims = null;					// Physical dimensions.
			var USE_DATASET_COLOURS = true;		// Do we use the colours from the data set when plotting infovis data.
			var USE_BREDTH_RENDER = false;		// Do we render the full width?
			
			
			var target_wCol = 0;  var target_wRow = 0;
			var current_wCol = 0; var current_wRow = 0;
			var windowsize = 10;
			
			
			var bP1Active = false;
			var bP2Active = false;
			
			/** Responses to auto-touch (i.e. interaction with physical bars). */
			function handleAutoTouch(touched, pushed, pulled) { 
				
				if (mode == "P1" && touched.length >= 1 && bP1Active == false)
				{
					target_wCol += (touched[0].col < 4) ? -1 : 1;
					bP1Active = true;
					after(1000, function() { bP1Active = false } );
					playSound("snd/buttons/on_affirm/xylophone_affirm1.wav");
				}
				if (mode == "P2" && touched.length >= 1 && bP2Active == false)
				{
					target_wCol += (touched[0].col < 4) ? -10 : 10;
					bP2Active = true;
					after(1000, function() { bP2Active = false } );
					playSound("snd/buttons/on_affirm/xylophone_affirm.wav");
				}
			}
			
			/** Redraw the data set with a given window. */
			function redraw(wrow, wcol) {
				
				// Limit to 0 and len-windowsize.
				wrow = wrow.clamp(0, dDataSet.rows.length - windowsize);
				wcol = wcol.clamp(0, dDataSet.columns.length - windowsize);
				
				// Compute the window.
				var data = identity();
				for (var row=0; row<windowsize; ++row)
				{
					for (var col=0; col<windowsize; ++col)
					{
						if (USE_BREDTH_RENDER)
							data[row][col] = dDataSet.block[0][wcol + col];
						else
							data[row][col] = dDataSet.block[wrow + row][wcol + col];
					}
				}
				
				// Push to the graph with explicit normalisation parameters.
				send("boundeddataset", { 
					data:data,
					minz: dDataSet.min - (dDataSet.min * 0.2),
					maxz: dDataSet.max + ((dDataSet.max-dDataSet.min) * 0.8),
				});
				
				// Update the rows and column labels to reflect the new window.
				for (var i=0; i<windowsize; ++i)
				{
					setXAxisLabel(i, dDataSet.columns[wcol + i])
					setYAxisLabel(i, dDataSet.rows[wrow + i])
				}
				
				// Update the position of the ghost scrollbars.
				$("#hscroll .ghost").css("left", ((wcol / dDataSet.columns.length) * 100) + "%");
				$("#vscroll .ghost").css("top", ((wrow / dDataSet.rows.length) * 100) + "%");
			}
			 
			/** Reset the study mode. */
			function setMode(mode){
				
				setAutoTouch(mode.startsWith("P"));
				
				if (mode == "V1")
				{
					$("vhscroll .nub").fadeIn();
					$("#hscroll .nub").fadeIn();
				}
				else
				{
					$("#vscroll .nub").fadeOut();
					$("#hscroll .nub").fadeOut();
				}
				
				$(".page").fadeOut();
				if (mode == "V2")
					$(".page").fadeIn();
					
					
				// Row colors
				//function rgb(r,g,b) { return {r:r,g:g,b:b} } 
				//blitRowColours([ rgb(255, 0, 0), rgb(0, 255, 0), rgb(0, 0, 255),rgb(255, 0, 0), rgb(0, 255, 0), rgb(0, 0, 255),rgb(255, 0, 0), rgb(0, 255, 0), rgb(0, 0, 255),rgb(255, 0, 0)  ])
			}
			
			
			function animate(){
				
				// Make sure we are running fast!
				send("zixelspeed", { speed: 0 });
				
				// Cap targets and current.
				target_wCol = target_wCol.clamp(0, dDataSet.columns.length);
				target_wRow = target_wRow.clamp(0, dDataSet.rows.length);
				current_wCol = current_wCol.clamp(0, dDataSet.columns.length);
				current_wRow = current_wRow.clamp(0, dDataSet.rows.length);
				
				// Compute direction of motion.
				var step = 1;
				var dx = (target_wCol < current_wCol) ? -step : step;
				var dy = (target_wRow < current_wRow) ? -step : step;
				
				// Bring it closer.
				var bMoved = false;
				if (target_wCol != current_wCol) { current_wCol += dx; bMoved -= true; }
				if (target_wRow != current_wRow) { current_wRow += dy; bMoved -= true;  }
				
				// Redraw and repeat.
				redraw(current_wRow, current_wCol);
				setTimeout(animate, 150);
				
				// Fancy sound.
				if (bMoved)
					playSound("snd/buttons/on_mouseover/sub_bass_mouseover.wav");
			}
			
			/** Start up the study. */
			$(document).ready(function() {
				
				// Start the touch events.
				initTouch();
				
				// Connect to the graph.
				initComms(STUDY, function(){ console.log("Connected to Graph Behaviour"); initModes("V1");  });
				
				// Graph dimensions.
				dims = dimensions();
				
				// Add axes.
				drawAxes();
				
				// Start off in V1 mode.
				
				animate();
				
				$("#datainfo").find("span.title").text("UK Rainfall (mm)");
				$("#datainfo").fadeIn();
			});
			
			/** Page bindings */
			$(".page").bind("touchstart", function() {  if (mode == "V2") target_wCol +=  parseInt($(this).attr("step")); });
			
			/** Scrollbar */
			$(".scroll").bind("touchmove", function(event) {
				
				// One event only, get position of touch as a percentage.
				var that = $(this);
				var touches = event.originalEvent.touches;
				if (touches.length != 1) return;
				var touch =  touches[0];
				
				// Compute position of touch as a percentage.
				var xaxis = that.attr("id") == "hscroll";
				var x = (touch.pageX - that.offset().left) / that.width();
				var y = (touch.pageY - that.offset().top)  / that.height();
				var percent = xaxis ? x : y;
				percent = percent.clamp(0, 0.9);// 1 - (windowsize / (xaxis ? dDataSet.columns.length : dDataSet.rows.length) )
				
				// Do we disable the nub?
				if (mode != "V1")
					return;
				
				// Update scrollbars.
				that.find(".nub").css(xaxis ? "left" : "top", (percent * 100) + "%");
				
				// Adjust the percentage relative to the window size.
				if (xaxis) target_wCol = Math.floor(dDataSet.columns.length * percent);
				else target_wRow = Math.floor(dDataSet.rows.length * percent);
				
			});
			
			
		</script>
		
	</body>
</html>
