<html>
	<head>
	
		<title>Graph Display - Filtering Study</title>
		
		<!-- Styles --> 
		<link rel="stylesheet" type="text/css" href="common.css">
		<style type="text/css">
			
			#datainfo { display: none; }
			
			.axislabel.y.target div.text { background-color: purple; } 
			.axislabel.y.target div.bar { background-color: purple; } 
			
		</style>
		
		<script type="text/javascript" src="js/jquery-1.8.2.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.9.1.custom.min.js"></script>
		<script type="text/javascript" src="js/jquery.nearest.min.js"></script>
		<script type="text/javascript" src="js/reconnecting-websocket.js"></script>
		<script type="text/javascript" src="js/ubidisplays-multitouch-0.8.js"></script>
		<script type="text/javascript" src="graph.js" type="text/javascript"></script>
		<script type="text/javascript" src="datasets.js"></script>
		
	</head>
	<body>
		
		<!-- STUDY BUTTONS -->
		<div id="studyheader">
			<p>Filtering Study</p>
			<ul id="modes">
				<li mode="V1"><span>V1</span><span>Virtual Drag Hide<span></li>
				<li mode="P1"><span>P1</span><span>Physical Manual Hide<span></li>
				<li mode="P2"><span>P2</span><span>Physical Assisted Hide<span></li>
				<li mode="P3"><span>P3</span><span>Physical Tap Comparison<span></li>
				<li mode="P4"><span>P4</span><span>Physical End Column Hide<span></li>
			</ul>
		</div>
		
		<!-- FUNCTION RENDER -->
		<div id="datainfo">
			<span class="title"></span>
			<br/>
			<br/>
			<span class="row"></span>
			<span class="col"></span>
			<br/>
			<span class="value"></span>
		</div>
		
		<script>
			// Constants
			var STUDY = 8383;					// Port for connection to the study behaviour.
			var dims = null;					// Physical dimensions.
			var USE_DATASET_COLOURS = true;		// Do we use the colours from the data set when plotting infovis data.
			var COMPARE_TIME = ANIM * 3;		// Comparison time.
			
			
			var p1Swapping = false;		// Is mode P1 swapping?
			var p2Swapping = false;		// Is mode P1 swapping?
			var p3Comparing = false;	// Is mode P2 comparing?
			
			/** Responses to auto-touch (i.e. interaction with physical bars). */
			function handleAutoTouch(touched, pushed, pulled) {
				
				// P2 -- Assisted hide.
				if (mode == "P2" && touched.length >= 1)
				{
					for (var i=0; i<touched.length; ++i)
						send("override", { x : touched[i].row, y : touched[i].col, z : 0.05, darken: 0.7 });	// set override
				}
				if (mode == "P2" && pulled.length == 1)
				{
					send("override", { x : pulled[0].row, y : pulled[0].col });	// clear override
				}
				
				// P3 -- Comparison of tapped.
				if (mode == "P3" && p3Comparing == false && touched.length >= 2)
				{
					compare(touched, COMPARE_TIME);
					p3Comparing = true;
					after(COMPARE_TIME, function() { p3Comparing = false; });
				}
				
				// P4 -- End tap
				if (mode == "P4" && touched.length >= 1)
				{
					for (var i=0; i<touched.length; ++i)
					{
						// If first col, hide row.
						if (touched[i].col == 0)
							send("override", { row : touched[i].row, z : 0.0, darken: 0.7 });
						
						// If first row, hide col.
						else if (touched[i].row == 0)
							send("override", { col : touched[i].col, z : 0.0, darken: 0.7 });
					}
				}
				
			}
			 
			/** Reset the study mode. */
			function setMode(mode){
				
				// Reset behaviour.
				send("reset");
				//send("override");
				
				// If we need auto-touch enabled.
				if (mode.startsWith("P"))
					setAutoTouch(true);
				else
					setAutoTouch(false);
				
				// Freeze or thaw.
				if (mode == "P1")
					after(ANIM*2, function(){ if (mode == "P1") send("freeze", { state : true } ); });
				else
					send("freeze", { state : false })
				
				// Reset the data set.
				graphDataSet("exports");
			}
			
			/** Animated comparison of two rows. */
			function compare(rows, time) {
				
				// Copy the start data set.
				var orig = deepCopy(_LastDataSet);
				
				// Remove all rows that are not in the comparison.
				var data = identity();
				for (var i = 0; i < rows.length; ++i)
					data[rows[i].row] = _LastDataSet[rows[i].row];
				blitData(data);
				
				// Swap 
				//after(time || (ANIM * 3), function(){	blitData(orig); });
			}
			
			
			var label = null;
			// Listen to all touch events on the top of the graph.
			$(document).bind("touchmove", function(event){
			
				// If we are in virtual mode.
				if (mode == "V1")
				{
					// Drop decoration.
					$(".axislabel").removeClass("selected");
					
					// Select the first touch in each border quadrant.
					var touches = event.originalEvent.touches;
					if (touches.length != 1)
						return;
					
					// Drop the touch if its out of bounds.
					var x = touches[0].pageX; var y = touches[0].pageY;
					if ((y / window.innerHeight) * 100 < GBOUNDY) return;
					if ((x / window.innerWidth) * 100 > GBOUNDMAX-GBOUNDY) return;
					
					// Get the nearest row.
					var list = $.nearest( {x : x, y : y }, ".axislabel");
					var selected = $(list.get(0));
					selected.addClass("selected");
					label = selected;
					// Select axes.
					//if 		(selected.data("axis") == "x") label = selected;
					//else if (selected.data("axis") == "y") label = selected;
				}
				
			});
			
			$(document).bind("touchend", function(event){
			
				// If we are in virtual mode.
				if (mode == "V1" && label != null)
				{
					var touches = event.originalEvent.touches;
					if (touches.length != 1) return;
					var x = touches[0].pageX / window.innerWidth;
					var y = touches[0].pageY / window.innerHeight;
					
					if (label.data("axis") == "x" && y > 0.9)
					{
						playSound("snd/buttons/on_alert/wobble_alert.wav");
						send("override", { col : label.data("idx"), z : 0.0, darken: 1.0 });
					}
					else if (label.data("axis") == "y" && x < 0.1)
					{
						playSound("snd/buttons/on_alert/wobble_alert.wav");
						send("override", { row : label.data("idx"), z : 0.0, darken: 1.0 });
					}
					label = null;
				}
				
			});
			
			/** Start up the study. */
			$(document).ready(function() {
				
				// Start the touch events.
				initTouch();
				
				// Connect to the graph.
				initComms(STUDY, function(){ console.log("Connected to Graph Behaviour"); initModes("V1"); });
				
				// Graph dimensions.
				dims = dimensions();
				
				// Add axes.
				drawAxes();
				
				// Start in mode 1.
				
				
				// Show a data set.
				graphDataSet("exports");
			});
			
			
		</script>
		
	</body>
</html>
